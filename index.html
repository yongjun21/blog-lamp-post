<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Lamp Posts</title>
    <link rel="stylesheet" href="lib/plottable.css">
    <style>
      @import "lib/datagovsg-charts.css";

      body {
        font-family: sans-serif;
      }

      header, section {
        margin: 0 auto;
        max-width: 900px;
        padding: 0 20px;
      }

      header {
        margin-top: 40px;
        margin-bottom: 40px;
      }

      section {
        margin-bottom: 100px;
      }

      h2 {
        text-align: center;
      }

      #map, #chart {
        height: 500px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Finding Lamp Post Spacing</h1>
      <label for="filter">Choose road</label>
      <select id="select" name="filter">
        <option value="ALL" selected>ALL</option>
        <option value="PAE02K">PIE</option>
        <option value="AYE00N">AYE</option>
        <option value="TAE00D">TPE</option>
        <option value="EAP01R">ECP</option>
        <option value="BUE01Q">BKE</option>
        <option value="SEE04Z">SLE</option>
        <option value="KRE01W">KJE</option>
        <option value="BUT03J">Bukit Timah Road</option>
      </select>
    </header>
    <section>
      <div id="map"></div>
    </section>
    <section>
      <h2>Histogram of distance to nearest neighbour for each lamp post</h2>
      <svg id="chart"></svg>
    </section>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjqDojkROjJTFkXw4PCvAS_tQTEHpgjdc"></script>
    <script src="lib/d3.min.js"></script>
    <script src="lib/plottable.min.js"></script>
    <script type="module">
      import mapStyle from './mapStyle.js'
      import {DatagovsgSimpleBar} from './lib/datagovsg-charts.min.js'

      const map = new google.maps.Map(document.getElementById('map'), {
        center: new google.maps.LatLng(1.352083, 103.819836),
        zoom: 12,
        styles: mapStyle
      })

      function generateLayer (roadId) {
        const layer = new google.maps.Data()
        layer.setStyle({
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 2,
            fillColor: 'yellow',
            fillOpacity: 0.8,
            strokeColor: 'yellow',
            strokeOpacity: 0,
            strokeWeight: 0
          },
          strokeWeight: 1
        })
        layer.loadGeoJson(`data/road/${roadId}.json`)
        layer.loadGeoJson(`data/lampPost/${roadId}.json`)
        return layer
      }

      function updateChart (roadId) {
        return window.fetch(`data/histogram/${roadId}.json`)
          .then(res => {
            if (res.status !== 200) return {}
            return res.json()
          })
          .then(histogram => {
            const series = []
            for (let i = 0; i < 50; i++) {
              series.push({label: i + 1, value: histogram[i + 1] || 0})
            }
            return series
          })
      }

      let layer = new google.maps.Data()

      const chart = new DatagovsgSimpleBar({
        data: [],
        xLabel: 'Meters',
        yLabel: 'Frequency'
      })
      chart.mount(document.getElementById('chart'))
      updateChart('ALL').then(series => chart.update({data: series}))

      const select = document.getElementById('select')
      select.addEventListener('change', event => {
        const selected = event.target.value
        layer.setMap(null)
        if (selected !== 'ALL') {
          layer = generateLayer(selected)
          layer.setMap(map)
        }
        updateChart(selected).then(series => chart.update({data: series}))
      })
    </script>
  </body>
</html>
